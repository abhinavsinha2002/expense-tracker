<div class="detail-container fade-in" *ngIf="!loading && group; else loadingTpl">
  <div class="hero-header" [style.background-image]="'url(' + getGroupImage(group.name) + ')'">
    <div class="overlay"></div>
    
    <div class="top-nav">
      <button mat-icon-button (click)="goBack()" class="glass-btn">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <button mat-flat-button color="accent" (click)="addExpense()" class="add-btn">
        <mat-icon>add</mat-icon> Add Expense
      </button>
    </div>

    <div class="hero-content">
      <h1>{{ group.name }}</h1>
      <p>{{ group.description || 'No description' }}</p>
      <div class="badges">
        <span class="badge"><mat-icon style="font-size: 14px; width:14px; height:14px; vertical-align: middle; margin-right: 4px;">public</mat-icon> {{ group.currency }}</span>
        <span class="badge"><mat-icon style="font-size: 14px; width:14px; height:14px; vertical-align: middle; margin-right: 4px;">group</mat-icon> {{ group.members?.length }} Members</span>
      </div>
    </div>
  </div>

  <div class="content-wrapper">
    <mat-tab-group mat-stretch-tabs="false" animationDuration="0ms" class="glass-tabs">
      
      <mat-tab label="Expenses">
        <div class="tab-content">
          
          <div *ngIf="expenses.length === 0" class="empty-state">
            <mat-icon>receipt_long</mat-icon>
            <p>No expenses recorded yet.</p>
            <button mat-stroked-button (click)="addExpense()">Add the first one</button>
          </div>
          
          <div class="expense-list">
            <div class="expense-item glass-card clickable" 
                 *ngFor="let exp of expenses" 
                 (click)="openExpenseDetail(exp)">
                 
              <div class="date-box">
                <span class="day">{{ getExpenseDate(exp.date) | date:'dd' }}</span>
                <span class="month">{{ getExpenseDate(exp.date) | date:'MMM yy' }}</span>
              </div>
              
              <div class="exp-info">
                <h4>{{ exp.description }}</h4>
                <p>Paid by <strong>{{ exp.owner.fullName }}</strong></p>
              </div>
              
              <div class="exp-amount">
                {{ exp.amount | currency : (group.currency || 'INR') }}
              </div>
            </div>
          </div>

        </div>
      </mat-tab>

      <mat-tab label="Balances">
        <div class="tab-content">
          <div *ngIf="settlements.length === 0" class="empty-state">
             <mat-icon>check_circle</mat-icon>
             <p>All settled up!</p>
          </div>
          
          <div class="settlement-list">
            <div class="settle-card glass-card" *ngFor="let s of settlements">
              <div class="user from">{{ s.fromUser }}</div>
              <div class="arrow">
                <span>pays</span>
                <mat-icon>arrow_forward</mat-icon>
                <span class="amount">{{ s.amount | currency : (group.currency || 'INR') }}</span>
              </div>
              <div class="user to">{{ s.toUser }}</div>
            </div>
          </div>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="loader-container" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
    <mat-progress-bar mode="indeterminate" style="width: 200px;"></mat-progress-bar>
    <p style="color: #aaa; margin-top: 15px; font-family: 'Poppins', sans-serif;">Loading Group...</p>
  </div>
</ng-template>

<div class="modal-overlay" *ngIf="showExpenseModal && selectedExpense">
  <div class="modal-card fade-in">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 style="margin: 0; font-size: 1.5rem;">Expense Details</h3>
      <button mat-icon-button (click)="closeModal()" style="color: #aaa;">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    
    <div class="modal-body-custom">
      <h2 class="exp-desc-large">{{ selectedExpense.description }}</h2>
      <p class="exp-date-sub">{{ getFormattedDate(selectedExpense.date) }}</p>

      <div class="divider-line"></div>

      <div class="info-row">
        <div class="icon-circle"><mat-icon>money</mat-icon></div>
        <div class="info-text">
          <span class="label">Total Amount</span>
          <span class="value gold-text">{{ currencySymbol }} {{ selectedExpense.amount }}</span>
        </div>
      </div>

      <div class="info-row">
        <div class="icon-circle"><mat-icon>person</mat-icon></div>
        <div class="info-text">
          <span class="label">Paid by</span>
          <span class="value">{{ selectedExpense.owner.fullName }}</span>
        </div>
      </div>

      <div class="info-row">
        <div class="icon-circle"><mat-icon>category</mat-icon></div>
        <div class="info-text">
          <span class="label">Category</span>
          <span class="value">{{ selectedExpense.category || 'General' }}</span>
        </div>
      </div>

      <div class="divider-line"></div>

      <h4 class="splits-title">Splits ({{ selectedExpense.splits?.length || 0 }})</h4>
      
      <div class="splits-container">
        <div class="split-row" *ngFor="let split of selectedExpense.splits">
          <div class="split-user">
            <div class="avatar-mini">{{ getInitials(getMemberName(split.member)) }}</div>
            <span>{{ getMemberName(split.member) }}</span>
          </div>
          <span class="split-val">{{ currencySymbol }} {{ split.amount }}</span>
        </div>
      </div>

    </div>

    <div class="d-flex gap-3 mt-4">
      <button class="create-btn flex-grow-1" *ngIf="isOwnerOfSelected" (click)="editExpense()">
        <mat-icon style="vertical-align: middle; font-size: 18px; width: 18px; height: 18px; margin-right: 4px;">edit</mat-icon>
        Edit Expense
      </button>
      <button class="btn btn-outline-light" (click)="closeModal()" style="border-radius: 50px; padding: 0 24px;" [ngClass]="{'flex-grow-1': !isOwnerOfSelected}">
        Close
      </button>
    </div>

  </div>
</div>